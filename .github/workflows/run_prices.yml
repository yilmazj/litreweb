import requests
import json
import time
from bs4 import BeautifulSoup
from datetime import datetime

# --- AYARLAR ---
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Origin": "https://www.google.com",
    "Referer": "https://www.google.com"
}

# 81 Ä°lin Plaka KodlarÄ± ve Ä°simleri
PROVINCES = {
    1: "ADANA", 6: "ANKARA", 7: "ANTALYA", 16: "BURSA", 34: "ISTANBUL (AVRUPA)", 
    35: "IZMIR", 934: "ISTANBUL (ANADOLU)" # BazÄ± firmalar Anadolu'yu ayrÄ± kodlar, bazÄ±sÄ± ilÃ§e olarak tutar.
    # BurayÄ± 81 il iÃ§in uzatabilirsin. Kodun hÄ±zlÄ± Ã§alÄ±ÅŸmasÄ± iÃ§in ÅŸimdilik bÃ¼yÃ¼k ÅŸehirleri aÃ§tÄ±m.
    # TÃ¼m 81 ili aÃ§mak istersen range(1, 82) dÃ¶ngÃ¼sÃ¼ kuracaÄŸÄ±z aÅŸaÄŸÄ±da.
}

# --- YARDIMCI FONKSÄ°YONLAR ---
def clean_price(price):
    """ FiyatÄ± temizler ve float yapar (Ã¶rn: '44,50 TL' -> 44.50) """
    if not price: return None
    try:
        # String deÄŸilse direkt dÃ¶ndÃ¼r
        if isinstance(price, (int, float)): return float(price)
        
        # Temizlik
        p = str(price).replace('â‚º', '').replace('TL', '').strip()
        p = p.replace(',', '.')
        return float(p)
    except:
        return None

# ==========================================
# 1. OPET (API - En SaÄŸlamÄ±)
# ==========================================
def fetch_opet(plaka_kodu):
    # Opet Anadolu yakasÄ±nÄ± ilÃ§e bazlÄ± ayÄ±rÄ±r ama biz il bazlÄ± Ã§ekiyoruz.
    # Opet API'sinde Ä°stanbul tek koddur (34), yakalar ilÃ§e detayÄ±ndadÄ±r.
    url = "https://api.opet.com.tr/api/fuelprices/prices"
    
    # Opet iÃ§in plaka kodu string olmalÄ±. Ä°stanbul Anadolu iÃ§in Ã¶zel ayar yok, 34 gÃ¶nderip ilÃ§eye bakÄ±lÄ±r.
    code_to_send = "34" if plaka_kodu == 934 else str(plaka_kodu)
    
    payload = {"ProvinceCode": code_to_send, "ViewType": 1}
    prices = {}

    try:
        r = requests.post(url, json=payload, headers=HEADERS, timeout=10)
        if r.status_code == 200:
            data = r.json()
            # Åehirdeki tÃ¼m ilÃ§elerin ortalamasÄ±nÄ± veya merkez ilÃ§eyi alalÄ±m.
            # Ä°lk gelen veriyi alÄ±yoruz (Genelde Merkez olur).
            if data and len(data) > 0:
                # Ä°stanbul Anadolu ise KadÄ±kÃ¶y'Ã¼ bulmaya Ã§alÄ±ÅŸ
                target_ilce = data[0] # VarsayÄ±lan
                
                if plaka_kodu == 934: # Anadolu YakasÄ±
                    for d in data:
                        if "KADIKOY" in d.get("districtName", "").upper():
                            target_ilce = d
                            break
                elif plaka_kodu == 34: # Avrupa YakasÄ±
                     for d in data:
                        if "SISLI" in d.get("districtName", "").upper():
                            target_ilce = d
                            break
                
                for p in target_ilce.get("prices", []):
                    name = p.get("productName", "").lower()
                    amt = p.get("amount")
                    if "kurÅŸunsuz" in name: prices["Benzin"] = clean_price(amt)
                    elif "motorin" in name: prices["Motorin"] = clean_price(amt)
                    elif "lpg" in name or "otogaz" in name: prices["LPG"] = clean_price(amt)
                    
    except Exception as e:
        print(f"Opet HatasÄ± ({plaka_kodu}): {e}")
    
    return prices

# ==========================================
# 2. AYTEMÄ°Z (API/POST Request)
# ==========================================
def fetch_aytemiz(plaka_kodu):
    # Aytemiz web sitesi arkada bir POST isteÄŸi atar.
    url = "https://www.aytemiz.com.tr/FuelPrice/GetFuelPrices"
    # Aytemiz'de Ä°stanbul tek 34'tÃ¼r.
    code = 34 if plaka_kodu == 934 else plaka_kodu
    
    prices = {}
    try:
        # Aytemiz form-data bekler
        r = requests.post(url, data={"CityId": code}, headers=HEADERS, timeout=10)
        if r.status_code == 200:
            data = r.json()
            # Gelen veri HTML snippet olabilir veya JSON. 
            # Aytemiz genelde JSON listesi dÃ¶ner: [{DistrictName: '...', Prices: [...]}]
            if isinstance(data, list) and len(data) > 0:
                # Yine ilÃ§e mantÄ±ÄŸÄ±, ilkini alalÄ±m
                item = data[0] 
                # Fiyatlar genelde key-value gelir
                prices["Benzin"] = clean_price(item.get("Gasoline95"))
                prices["Motorin"] = clean_price(item.get("Diesel"))
                prices["LPG"] = clean_price(item.get("Lpg"))
    except Exception as e:
        print(f"Aytemiz HatasÄ±: {e}")
        
    return prices

# ==========================================
# 3. PETROL OFÄ°SÄ° (API)
# ==========================================
def fetch_po(plaka_kodu):
    # PO API'si: https://www.petrolofisi.com.tr/api/fuel-prices?province=ISTANBUL
    # Plaka kodundan ÅŸehir ismini bulmamÄ±z lazÄ±m (Basit map)
    # Åimdilik manuel map kullanÄ±yorum, sen bunu geniÅŸletebilirsin.
    city_map = {34: "ISTANBUL", 6: "ANKARA", 35: "IZMIR", 1: "ADANA", 934: "ISTANBUL"}
    city_name = city_map.get(plaka_kodu, "ISTANBUL")
    
    url = f"https://www.petrolofisi.com.tr/api/fuel-prices?province={city_name}"
    # Anadolu yakasÄ± iÃ§in ilÃ§e filtresi eklemek gerekir: &district=KADIKOY
    if plaka_kodu == 934: url += "&district=KADIKOY"
    elif plaka_kodu == 34: url += "&district=SISLI"
    
    prices = {}
    try:
        r = requests.get(url, headers=HEADERS, timeout=10)
        if r.status_code == 200:
            data = r.json()
            # YapÄ±: { prices: [ { productName: '...', price: 44.50 } ] }
            for p in data.get("prices", []):
                name = p.get("productName", "").lower()
                val = p.get("price")
                if "kurÅŸunsuz" in name: prices["Benzin"] = clean_price(val)
                elif "motorin" in name: prices["Motorin"] = clean_price(val)
                elif "lpg" in name or "po/gaz" in name: prices["LPG"] = clean_price(val)
    except Exception as e:
        print(f"PO HatasÄ±: {e}")
        
    return prices

# ==========================================
# 4. TOTAL ENERGIES (HTML Parse)
# ==========================================
def fetch_total(plaka_kodu):
    # Total'in sitesi biraz karÄ±ÅŸÄ±ktÄ±r, genelde Opet/PO verisine yakÄ±ndÄ±r.
    # HTML parse etmek gerekir.
    # Demo amaÃ§lÄ± Opet verisine referans veriyorum Ã§Ã¼nkÃ¼ Total sitesi bot korumalÄ± (Cloudflare).
    # Ancak "requests" ile denemek istersen:
    # url = "https://www.totalenergies.com.tr/..."
    # Åimdilik boÅŸ dÃ¶nÃ¼yoruz, hatalÄ± veri vermemek iÃ§in.
    return {} 

# ==========================================
# 5. TÃœRKÄ°YE PETROLLERÄ° (TP)
# ==========================================
def fetch_tp(plaka_kodu):
    # TPPD sitesi genelde basittir.
    # https://www.tppd.com.tr/tr/akaryakit-fiyatlari
    # BurasÄ± dinamik olduÄŸu iÃ§in requests ile zorlanabilir.
    return {}

# ==========================================
# 6. SHELL (Zorlu - HTML)
# ==========================================
def fetch_shell(plaka_kodu):
    # Shell verisi HTML iÃ§inden regex ile Ã§ekilebilir.
    # Shell TÃ¼rkiye URL'si sabittir.
    # Fakat il bazlÄ± sorgu iÃ§in cookie gerekir.
    # Shell fiyatlarÄ± genelde PO ile kuruÅŸu kuruÅŸuna aynÄ±dÄ±r veya +5 kuruÅŸ fark eder.
    return {}

# ==========================================
# ANA MOTOR (81 Ä°L DÃ–NGÃœSÃœ)
# ==========================================
def main():
    print("ğŸš€ Litre App 81 Ä°l Tarama BaÅŸlatÄ±lÄ±yor...")
    
    all_data = []
    
    # Test iÃ§in sadece belli illeri tarÄ±yorum. 
    # GerÃ§ekte: for plaka in range(1, 82): yapacaksÄ±n.
    # AyrÄ±ca Ä°stanbul Anadolu (934) eklemeyi unutma.
    
    target_provinces = [34, 934, 6, 35, 1] # Ä°stanbul Avr, Ä°st And, Ankara, Ä°zmir, Adana
    
    for plaka in target_provinces:
        sehir_adi = PROVINCES.get(plaka, f"SEHIR_{plaka}")
        print(f"ğŸ“ TaranÄ±yor: {sehir_adi} ({plaka})...")
        
        il_verisi = {
            "plaka": plaka,
            "sehir": sehir_adi,
            "tarih": datetime.now().strftime("%Y-%m-%d %H:%M"),
            "istasyonlar": {}
        }
        
        # --- OPET ---
        il_verisi["istasyonlar"]["Opet"] = fetch_opet(plaka)
        
        # --- AYTEMÄ°Z ---
        il_verisi["istasyonlar"]["Aytemiz"] = fetch_aytemiz(plaka)
        
        # --- PETROL OFÄ°SÄ° (BP Dahil) ---
        il_verisi["istasyonlar"]["Petrol Ofisi"] = fetch_po(plaka)
        
        # --- TOTAL & SHELL & TP ---
        # Bot korumasÄ± yÃ¼zÃ¼nden requests ile boÅŸ gelebilir.
        # Bu durumda en mantÄ±klÄ±sÄ±: Opet verisini alÄ±p +0.05 kuruÅŸ marjla gÃ¶stermek 
        # veya "Fiyat istasyonda" yazmaktÄ±r. YanlÄ±ÅŸ veri girmemek iÃ§in boÅŸ bÄ±rakÄ±yorum.
        il_verisi["istasyonlar"]["Shell"] = fetch_shell(plaka)
        il_verisi["istasyonlar"]["Total"] = fetch_total(plaka)
        
        all_data.append(il_verisi)
        
        # Ã‡ok hÄ±zlÄ± istek atÄ±p ban yemeyelim diye 1 saniye bekle
        time.sleep(1)

    print("\nâœ… TARAMA BÄ°TTÄ°. Ã–RNEK JSON:\n")
    print(json.dumps(all_data, indent=4, ensure_ascii=False))
    
    # Buradan sonra all_data'yÄ± Firebase'e basabilirsin.

if __name__ == "__main__":
    main()
